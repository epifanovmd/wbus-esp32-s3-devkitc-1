#pragma once
#include <Arduino.h>
#include <map>

struct WBusErrorType
{
    uint8_t code;
    String name;
    String description;

    WBusErrorType() : code(0) {}
    WBusErrorType(uint8_t c, const String &n, const String &d)
        : name(n), description(d), code(c) {}
};

class WBusErrorMap
{
private:
    WBusErrorMap()
    {
        initialize();
    }

    std::map<uint8_t, WBusErrorType> types;

    void initialize()
    {
        // Инициализация всех ошибок

        // 0x00 - 0x0F
        types[0x00] = WBusErrorType(0x00, "Нет ошибок", "Нет ошибок");
        types[0x01] = WBusErrorType(0x01, "Ошибка блока управления", "Неисправен блок управления, ошибка в программе EOL или неисправен датчик температуры ОЖ");
        types[0x02] = WBusErrorType(0x02, "Нет запуска", "Даже после повторного старта пламя не образуется");
        types[0x03] = WBusErrorType(0x03, "Обрыв пламени", "Ошибка датчика пламени, пламя не обнаружено при работе");
        types[0x04] = WBusErrorType(0x04, "Повышенное напряжение", "Рабочее напряжение слишком долго превышало максимально допустимый уровень");
        types[0x05] = WBusErrorType(0x05, "Преждевременное распознавание пламени", "Датчик в камере сгорания распознал пламя раньше начала рабочего режима");
        types[0x06] = WBusErrorType(0x06, "Перегрев нагревательного блока", "Температура нагревательного элемента превысила допустимый предел");
        types[0x07] = WBusErrorType(0x07, "Блокировка нагревательного блока", "Активирована блокировка нагревательного блока");
        types[0x08] = WBusErrorType(0x08, "Короткое замыкание насоса-дозатора", "Электрическая цепь насоса-дозатора замыкается на массу");
        types[0x09] = WBusErrorType(0x09, "Короткое замыкание нагнетателя", "Электрическая цепь нагнетателя замыкается на массу");
        types[0x0A] = WBusErrorType(0x0A, "Короткое замыкание штифта накала/датчика пламени", "Электрическая цепь штифта накала/датчика пламени замыкается на массу");
        types[0x0B] = WBusErrorType(0x0B, "Короткое замыкание циркуляционного насоса", "Электрическая цепь циркуляционного насоса замыкается на массу или произошла перегрузка мотора");
        types[0x0C] = WBusErrorType(0x0C, "Нет связи с кондиционером", "Нет связи с системой кондиционирования");
        types[0x0D] = WBusErrorType(0x0D, "Короткое замыкание зеленого светодиода", "Электрическая цепь зеленого светодиода замыкается на массу");
        types[0x0E] = WBusErrorType(0x0E, "Короткое замыкание желтого светодиода", "Электрическая цепь желтого светодиода замыкается на массу");
        types[0x0F] = WBusErrorType(0x0F, "Нет сигнала конфигурации", "Нет сигнала конфигурации от системы управления");

        // 0x10 - 0x1F
        types[0x10] = WBusErrorType(0x10, "Короткое замыкание клапана переключения ОЖ", "Электрическая цепь клапана переключения ОЖ замыкается на массу");
        types[0x11] = WBusErrorType(0x11, "Неправильно запрограммированный блок управления", "Неправильно запрограммированный блок управления или неправильно установленный подогреватель (относительно вида топлива)");
        types[0x12] = WBusErrorType(0x12, "Ошибка связи W-Bus", "Ошибка связи по шине W-Bus");
        types[0x13] = WBusErrorType(0x13, "Короткое замыкание в штатном вентиляторе автомобиля", "Электрическая цепь штатного вентилятора автомобиля замыкается на массу");
        types[0x14] = WBusErrorType(0x14, "Короткое замыкание температурного датчика", "Электрическая цепь температурного датчика замыкается на массу");
        types[0x15] = WBusErrorType(0x15, "Защита от блокировки мотора нагнетателя", "Сработала защита от блокировки мотора нагнетателя");
        types[0x16] = WBusErrorType(0x16, "Короткое замыкание главного выключателя", "Электрическая цепь главного выключателя замыкается на массу");
        types[0x17] = WBusErrorType(0x17, "Неверное уменьшение воздушного потока", "Неверное уменьшение воздушного потока в системе");
        types[0x18] = WBusErrorType(0x18, "Ошибка связи по пользовательской шине", "Ошибка связи по пользовательской шине");
        types[0x19] = WBusErrorType(0x19, "Короткое замыкание в цепи штифта накала", "Электрическая цепь штифта накала замыкается на массу");
        types[0x1A] = WBusErrorType(0x1A, "Короткое замыкание датчика пламени", "Электрическая цепь датчика пламени замыкается на массу");
        types[0x1B] = WBusErrorType(0x1B, "Короткое замыкание датчика перегрева", "В соединительном жгуте элемента короткое замыкание на массу");
        types[0x1C] = WBusErrorType(0x1C, "Ошибка 28", "Внутренняя ошибка блока управления");
        types[0x1D] = WBusErrorType(0x1D, "Короткое замыкание теста соленоидного клапана", "Электрическая цепь теста соленоидного клапана замыкается на массу");
        types[0x1E] = WBusErrorType(0x1E, "Короткое замыкание датчика топлива", "Электрическая цепь датчика топлива замыкается на массу");
        types[0x1F] = WBusErrorType(0x1F, "Короткое замыкание нагрева форсунки", "Электрическая цепь нагрева форсунки замыкается на массу");

        // 0x20 - 0x2F
        types[0x20] = WBusErrorType(0x20, "Короткое замыкание индикатора работы", "Электрическая цепь индикатора работы замыкается на массу");
        types[0x21] = WBusErrorType(0x21, "Короткое замыкание индикатора пламени", "Электрическая цепь индикатора пламени замыкается на массу");
        types[0x22] = WBusErrorType(0x22, "Неверное опорное сопротивление", "Неверное значение опорного сопротивления");
        types[0x23] = WBusErrorType(0x23, "Активирована блокировка при аварии", "Активирована блокировка при аварии (акселерометр)");
        types[0x24] = WBusErrorType(0x24, "Автомобиль почти без топлива", "Уровень топлива в баке слишком низкий");
        types[0x25] = WBusErrorType(0x25, "Короткое замыкание подогрева топлива", "Электрическая цепь подогрева топлива замыкается на массу");
        types[0x26] = WBusErrorType(0x26, "Короткое замыкание датчика температуры платы", "Электрическая цепь датчика температуры платы замыкается на массу");
        types[0x27] = WBusErrorType(0x27, "Обрыв заземления блока управления", "Обрыв цепи заземления блока управления");
        types[0x28] = WBusErrorType(0x28, "Менеджер бортовой сети низкое напряжение", "Низкое напряжение от менеджера бортовой сети");
        types[0x29] = WBusErrorType(0x29, "Топливная прокачка не выполнена", "Не выполнена процедура прокачки топлива");
        types[0x2A] = WBusErrorType(0x2A, "Ошибка в радиотелеграмме", "Ошибка в радиотелеграмме удаленного управления");
        types[0x2B] = WBusErrorType(0x2B, "Telestart не запрограммирован", "Модуль Telestart не запрограммирован");
        types[0x2C] = WBusErrorType(0x2C, "Короткое замыкание датчика давления", "Электрическая цепь датчика давления замыкается на массу");
        types[0x2D] = WBusErrorType(0x2D, "Неисправность в цепи нагнетателя", "Число оборотов вращения мотора нагнетателя ниже необходимого значения");
        types[0x2E] = WBusErrorType(0x2E, "Неисправность в цепи штифта накала", "Сопротивление штифта накала находится вне допустимых значений");
        types[0x2F] = WBusErrorType(0x2F, "Обрыв пламени", "Пламя погасло во время рабочего режима. Выполняется попытка запуска");

        // 0x30 - 0x3F
        types[0x30] = WBusErrorType(0x30, "Ошибка пользователя 1", "Пользовательская специфическая ошибка 1");
        types[0x31] = WBusErrorType(0x31, "Ошибка пользователя 2", "Пользовательская специфическая ошибка 2");
        types[0x32] = WBusErrorType(0x32, "Нет запуска из периода холостого хода", "Не удалось запустить нагреватель из периода холостого хода");
        types[0x33] = WBusErrorType(0x33, "Неверный сигнал датчика пламени", "Неверный или отсутствующий сигнал от датчика пламени");
        types[0x34] = WBusErrorType(0x34, "Введены значения по умолчанию", "В память были загружены значения по умолчанию");
        types[0x35] = WBusErrorType(0x35, "Программирование EOL не выполнено", "Программирование EOL (End Of Line) не было выполнено");
        types[0x36] = WBusErrorType(0x36, "Короткое замыкание термопредохранителя", "Электрическая цепь термопредохранителя замыкается на массу");
        types[0x37] = WBusErrorType(0x37, "Слишком высокая температура ОЖ при первом вводе в эксплуатацию", "Температура ОЖ превысила допустимый предел при первом запуске");
        types[0x38] = WBusErrorType(0x38, "Первая попытка запуска неудачная", "Первая попытка запуска не удалась");
        types[0x39] = WBusErrorType(0x39, "Первая попытка запуска неудачная - нет повторного запуска", "Первая попытка запуска не удалась и повторный запуск не выполнен");
        types[0x3A] = WBusErrorType(0x3A, "Короткое замыкание в шине W-Bus / LIN-Bus", "Шина W-Bus или LIN-Bus замыкается на массу");
        types[0x3B] = WBusErrorType(0x3B, "Ошибка 59", "Внутренняя ошибка программного обеспечения");
        types[0x3C] = WBusErrorType(0x3C, "Внутренняя ошибка блока 60 управления", "Внутренняя ошибка процессора блока управления");
        types[0x3D] = WBusErrorType(0x3D, "Внутренняя ошибка блока 61 управления", "Внутренняя ошибка памяти блока управления");
        types[0x3E] = WBusErrorType(0x3E, "Внутренняя ошибка блока 62 управления", "Внутренняя ошибка периферии блока управления");
        types[0x3F] = WBusErrorType(0x3F, "Загружено неправильное программное обеспечение", "В блок управления загружено несовместимое программное обеспечение");

        // 0x40 - 0x4F
        types[0x40] = WBusErrorType(0x40, "Пользовательская ошибка 1", "Пользовательская ошибка для конкретного производителя автомобиля");
        types[0x4C] = WBusErrorType(0x4C, "Высокое напряжение при защите компонентов", "Отключение для защиты компонентов при экстремально высоком уровне напряжения");

        // 0x50 - 0x5F
        types[0x50] = WBusErrorType(0x50, "Интерфейс пользователя в режиме ожидания", "Интерфейс пользователя находится в режиме ожидания (нет связи)");
        types[0x51] = WBusErrorType(0x51, "Интерфейс пользователя с ошибкой связи", "Интерфейс пользователя имеет ошибку связи");
        types[0x52] = WBusErrorType(0x52, "Интерфейс не отправляет определенный режим работы", "Интерфейс пользователя не отправляет определенный режим работы");
        types[0x53] = WBusErrorType(0x53, "Сообщение о состоянии вентилятора отрицательное", "Сообщение о состоянии вентилятора автомобиля отрицательное");
        types[0x54] = WBusErrorType(0x54, "Шина вентилятора замыкает на питание", "Шина управления вентилятором автомобиля замыкает на питание");
        types[0x55] = WBusErrorType(0x55, "Неисправность датчика температуры воды", "Неисправность датчика температуры охлаждающей жидкости");
        types[0x56] = WBusErrorType(0x56, "Датчик температуры воды замыкает на питание", "Датчик температуры охлаждающей жидкости замыкает на питание");
        types[0x57] = WBusErrorType(0x57, "Перегрев датчика температуры воды", "Перегрев датчика температуры охлаждающей жидкости");
        types[0x58] = WBusErrorType(0x58, "Превышение градиента датчика температуры воды", "Превышение максимального градиента изменения температуры ОЖ");
        types[0x59] = WBusErrorType(0x59, "Перегрев датчика температуры обдува", "Перегрев датчика температуры воздуха на выходе");
        types[0x5A] = WBusErrorType(0x5A, "Превышение градиента датчика низкой температуры", "Превышение градиента датчика температуры воздуха");
        types[0x5B] = WBusErrorType(0x5B, "Перегрев датчика температуры платы", "Перегрев датчика температуры печатной платы");
        types[0x5C] = WBusErrorType(0x5C, "Превышение градиента датчика температуры платы", "Превышение градиента датчика температуры печатной платы");
        types[0x5D] = WBusErrorType(0x5D, "Неисправность датчика температуры салона", "Неисправность датчика температуры салона");
        types[0x5E] = WBusErrorType(0x5E, "Ошибка градиента датчика пламени", "Ошибка градиента датчика пламени (резкое изменение)");
        types[0x5F] = WBusErrorType(0x5F, "Аварийное охлаждение", "Активировано аварийное охлаждение системы");

        // 0x60 - 0x6F
        types[0x60] = WBusErrorType(0x60, "Пользовательская ошибка 1", "Пользовательская специфическая ошибка (заводская настройка)");
        types[0x62] = WBusErrorType(0x62, "Переполнение значения таймера DP_max", "Переполнение значения таймера DP_max");
        types[0x63] = WBusErrorType(0x63, "Пользовательская ошибка 3", "Пользовательская специфическая ошибка 3");

        // 0x70 - 0x7F
        types[0x7F] = WBusErrorType(0x7F, "Пользовательская ошибка 32", "Пользовательская специфическая ошибка 32");

        // 0x80 - 0x8F
        types[0x80] = WBusErrorType(0x80, "Ошибка 128", "Неопределенная ошибка блока управления");
        types[0x81] = WBusErrorType(0x81, "Ошибка контрольной суммы EOL", "В программном обеспечении в EEPROM имеется ошибка контрольной суммы");
        types[0x82] = WBusErrorType(0x82, "Нет запуска в тестовом режиме", "Нагреватель не запускается в тестовом режиме");
        types[0x83] = WBusErrorType(0x83, "Обрыв пламени (FAZ)", "Во время цикла прогрева пламя гасло больше число раз (FAZ), чем запрограммировано в EEPROM");
        types[0x84] = WBusErrorType(0x84, "Пониженное напряжение", "Рабочее напряжение слишком долго находилось ниже минимально допустимого уровня");
        types[0x85] = WBusErrorType(0x85, "Пламя обнаружено после горения", "Датчик пламени обнаружил пламя после остановки процесса горения");
        types[0x86] = WBusErrorType(0x86, "Ошибка 134", "Неисправность системы удаления выхлопных газов");
        types[0x87] = WBusErrorType(0x87, "Постоянная блокировка подогревателя", "Активирована постоянная блокировка подогревателя");
        types[0x88] = WBusErrorType(0x88, "Обрыв насоса-дозатора", "Обрыв в электроцепи насоса-дозатора, или цепь замыкается на «+»");
        types[0x89] = WBusErrorType(0x89, "Обрыв нагнетателя", "Обрыв в электроцепи нагнетателя, или цепь замыкается на «+»");
        types[0x8A] = WBusErrorType(0x8A, "Обрыв штифта накала/датчика пламени", "Обрыв в электроцепи штифта накала/датчика пламени, или цепь замыкается на «+»");
        types[0x8B] = WBusErrorType(0x8B, "Обрыв циркуляционного насоса", "Обрыв в электроцепи циркуляционного насоса, или цепь замыкается на «+»");
        types[0x8C] = WBusErrorType(0x8C, "Ошибка 140", "Обрыв цепи управления вспомогательными устройствами");
        types[0x8D] = WBusErrorType(0x8D, "Обрыв зеленого светодиода", "Обрыв в электроцепи зеленого светодиода, или цепь замыкается на «+»");
        types[0x8E] = WBusErrorType(0x8E, "Обрыв желтого светодиода", "Обрыв в электроцепи желтого светодиода, или цепь замыкается на «+»");
        types[0x8F] = WBusErrorType(0x8F, "Ошибка 143", "Обрыв цепи питания периферийных устройств");

        // 0x90 - 0x9F
        types[0x90] = WBusErrorType(0x90, "Обрыв клапана переключения ОЖ", "Обрыв в электроцепи клапана переключения ОЖ, или цепь замыкается на «+»");
        types[0x91] = WBusErrorType(0x91, "Блок управления заблокирован или закодирован как нейтральный", "Блок управления заблокирован или закодирован как нейтральный (не активирован)");
        types[0x92] = WBusErrorType(0x92, "Ошибка обработки команд", "Ошибка в обработке команд. При возникновении нет функционирования или отключение по ошибке");
        types[0x93] = WBusErrorType(0x93, "Ошибка 147", "Обрыв цепи питания системы управления");
        types[0x94] = WBusErrorType(0x94, "Обрыв температурного датчика", "Обрыв в электроцепи температурного датчика, или цепь замыкается на «+»");
        types[0x95] = WBusErrorType(0x95, "Нагнетатель зажат", "Механическая блокировка нагнетателя");
        types[0x96] = WBusErrorType(0x96, "Ошибка 150", "Обрыв цепи датчика положения заслонки");
        types[0x97] = WBusErrorType(0x97, "Датчик перегрева установлен неверно", "Датчик перегрева установлен в неправильном положении");
        types[0x98] = WBusErrorType(0x98, "Обрыв источника питания", "Обрыв в цепи питания блока управления");
        types[0x99] = WBusErrorType(0x99, "Обрыв штифта накала", "Обрыв в электроцепи штифта накала, или цепь замыкается на «+»");
        types[0x9A] = WBusErrorType(0x9A, "Обрыв датчика пламени", "Обрыв в электроцепи датчика пламени, или цепь замыкается на «+»");
        types[0x9B] = WBusErrorType(0x9B, "Неверный задатчик", "Неверное значение задатчика или его отсутствие");
        types[0x9C] = WBusErrorType(0x9C, "Интеллектуальное отключение при пониженном напряжении", "Имеющееся время прогрева интеллектуального отключения при пониженном напряжении истекло");
        types[0x9D] = WBusErrorType(0x9D, "Обрыв теста соленоидного клапана", "Обрыв в электроцепи теста соленоидного клапана, или цепь замыкается на «+»");
        types[0x9E] = WBusErrorType(0x9E, "Обрыв датчика топлива", "Обрыв в электроцепи датчика топлива, или цепь замыкается на «+»");
        types[0x9F] = WBusErrorType(0x9F, "Обрыв нагрева форсунки", "Обрыв в электроцепи нагрева форсунки, или цепь замыкается на «+»");

        // 0xA0 - 0xAF
        types[0xA0] = WBusErrorType(0xA0, "Обрыв индикатора работы", "Обрыв в электроцепи индикатора работы, или цепь замыкается на «+»");
        types[0xA1] = WBusErrorType(0xA1, "Обрыв индикатора пламени", "Обрыв в электроцепи индикатора пламени, или цепь замыкается на «+»");
        types[0xA2] = WBusErrorType(0xA2, "Ошибка 162", "Обрыв цепи датчика качества топлива");
        types[0xA4] = WBusErrorType(0xA4, "Ошибка 164", "Обрыв цепи датчика давления топлива");
        types[0xA5] = WBusErrorType(0xA5, "Обрыв подогрева топлива", "Обрыв в электроцепи подогрева топлива, или цепь замыкается на «+»");
        types[0xA6] = WBusErrorType(0xA6, "Обрыв датчика температуры платы", "Обрыв в электроцепи датчика температуры платы, или цепь замыкается на «+»");
        types[0xA7] = WBusErrorType(0xA7, "Ошибка 167", "Обрыв цепи обратной связи системы управления");
        types[0xA8] = WBusErrorType(0xA8, "Ошибка связи менеджера бортовой сети", "Ошибка связи с менеджером бортовой сети автомобиля");
        types[0xA9] = WBusErrorType(0xA9, "Ошибка 169", "Обрыв цепи связи с дополнительным оборудованием");
        types[0xAA] = WBusErrorType(0xAA, "Неудачная отправка команд в шину W-Bus", "Неудачная отправка команд в шину W-Bus (даже после 4-хкратного повтора, нет ответа или ответ с помехами)");
        types[0xAB] = WBusErrorType(0xAB, "Обрыв датчика перегрева", "Обрыв в электроцепи датчика перегрева, или цепь замыкается на «+»");
        types[0xAC] = WBusErrorType(0xAC, "Неисправность датчика давления", "Неисправность датчика давления в системе");

        // 0xB0 - 0xBF
        types[0xB5] = WBusErrorType(0xB5, "Ошибка 181", "Обрыв цепи датчика уровня топлива");
        types[0xB6] = WBusErrorType(0xB6, "Обрыв термопредохранителя", "Обрыв в электроцепи термопредохранителя, или цепь замыкается на «+»");

        // 0xC0 - 0xCF

        // 0xD0 - 0xDF
        types[0xD0] = WBusErrorType(0xD0, "Ошибка 208", "Критическая ошибка системы управления");

        // 0xE0 - 0xEF
        types[0xE0] = WBusErrorType(0xE0, "Пользовательская ошибка 33", "Пользовательская специфическая ошибка для OEM производителя");

        // 0xF0 - 0xFF
        types[0xFE] = WBusErrorType(0xFE, "Пользовательская ошибка 63", "Пользовательская специфическая ошибка максимального индекса");
        types[0xFF] = WBusErrorType(0xFF, "Неизвестный код ошибки", "Неизвестный или нераспознанный код ошибки");
    }

public:
    // Singleton pattern для доступа к единственному экземпляру
    static WBusErrorMap &getInstance()
    {
        static WBusErrorMap instance;
        return instance;
    }

    // Получить информацию об ошибке по коду
    WBusErrorType getError(uint8_t code) const
    {
        auto it = types.find(code);
        if (it != types.end())
        {
            return it->second;
        }
        // Возвращаем ошибку по умолчанию если код не найден
        return WBusErrorType(code, "Неизвестная ошибка", "Код ошибки не распознан: 0x" + String(code, HEX));
    }

    // Получить название ошибки
    String getErrorName(uint8_t code) const
    {
        auto it = types.find(code);
        if (it != types.end())
        {
            return it->second.name;
        }
        return "Неизвестная ошибка (0x" + String(code, HEX) + ")";
    }

    // Получить описание ошибки
    String getErrorDescription(uint8_t code) const
    {
        auto it = types.find(code);
        if (it != types.end())
        {
            return it->second.description;
        }
        return "Описание не доступно для кода: 0x" + String(code, HEX);
    }

    // Проверить существует ли ошибка с таким кодом
    bool errorExists(uint8_t code) const
    {
        return types.find(code) != types.end();
    }

    // Получить информацию в JSON формате
    String getErrorJson(uint8_t code) const
    {
        WBusErrorType error = getError(code);
        String json = "{";

        json += "\"code\":\"0x" + String(code, HEX) + "\",";
        json += "\"name\":\"" + error.name + "\",";
        json += "\"description\":\"" + error.description + "\"";
        json += "}";
        return json;
    }

private:
    // Запрещаем копирование
    WBusErrorMap(const WBusErrorMap &) = delete;
    WBusErrorMap &operator=(const WBusErrorMap &) = delete;
};